# 小铁 v0.3.0 迭代计划

基于对 Aider、Open Interpreter、GPT-Engineer、Devika 等开源项目的学习

---

## 1. 命令系统重构 (学习 Aider)

### 当前问题
- 命令硬编码在 cli.py 的 if-elif 链中
- 不易扩展，无补全支持

### 改进方案
```python
# xiaotie/commands.py
class Commands:
    """命令管理器 - 约定优于配置"""

    def __init__(self, agent):
        self.agent = agent

    # 以 cmd_ 前缀的方法自动注册为命令
    def cmd_help(self, args: str) -> str:
        """显示帮助信息"""
        return self._generate_help()

    def cmd_tools(self, args: str) -> str:
        """显示可用工具"""
        ...

    def cmd_model(self, args: str) -> str:
        """切换模型"""
        ...

    # 补全支持
    def completions_model(self) -> list[str]:
        return ["gpt-4o", "claude-3-5-sonnet", "glm-4.7"]
```

---

## 2. 代码库感知 (学习 Aider RepoMap)

### 新增功能
- 自动分析项目结构
- 智能上下文选择
- Token 预算管理

### 实现方案
```python
# xiaotie/repomap.py
class RepoMap:
    """代码库映射"""

    def __init__(self, workspace_dir: str):
        self.workspace = Path(workspace_dir)
        self.cache = {}

    def get_repo_map(self, max_tokens: int = 2000) -> str:
        """生成代码库概览"""
        # 1. 扫描文件结构
        # 2. 提取关键定义 (class, function)
        # 3. 按相关性排序
        # 4. 截断到 token 预算
        ...

    def get_relevant_files(self, query: str) -> list[str]:
        """根据查询找相关文件"""
        ...
```

---

## 3. 增强输出显示 (学习 Open Interpreter)

### 新增功能
- Markdown 渲染
- 代码高亮
- 进度指示器

### 实现方案
```python
# xiaotie/display.py
from rich.console import Console
from rich.markdown import Markdown
from rich.syntax import Syntax
from rich.progress import Progress

class Display:
    """终端显示增强"""

    def __init__(self):
        self.console = Console()

    def markdown(self, text: str):
        """渲染 Markdown"""
        self.console.print(Markdown(text))

    def code(self, code: str, language: str = "python"):
        """代码高亮"""
        self.console.print(Syntax(code, language))

    def thinking(self, text: str):
        """显示思考过程（可折叠）"""
        ...
```

---

## 4. 多工具并行执行

### 当前问题
- 工具串行执行
- 无法利用并发优势

### 改进方案
```python
# 在 agent.py 中
async def _execute_tools_parallel(self, tool_calls: list[ToolCall]):
    """并行执行独立的工具调用"""
    tasks = []
    for tc in tool_calls:
        tool = self.tools[tc.function.name]
        tasks.append(tool.execute(**tc.function.arguments))

    results = await asyncio.gather(*tasks, return_exceptions=True)
    return results
```

---

## 5. 新增工具

### 5.1 Web 搜索工具
```python
class WebSearchTool(Tool):
    """网络搜索"""
    name = "web_search"

    async def execute(self, query: str) -> ToolResult:
        # 使用 DuckDuckGo 或其他搜索 API
        ...
```

### 5.2 Git 工具
```python
class GitTool(Tool):
    """Git 操作"""
    name = "git"

    async def execute(self, command: str) -> ToolResult:
        # status, diff, commit, log 等
        ...
```

### 5.3 代码分析工具
```python
class CodeAnalysisTool(Tool):
    """代码分析"""
    name = "analyze_code"

    async def execute(self, file_path: str) -> ToolResult:
        # 提取函数、类、依赖关系
        ...
```

---

## 6. 配置系统增强

### 支持多配置源
```yaml
# ~/.xiaotie/config.yaml (全局)
# ./xiaotie.yaml (项目级)
# 环境变量 XIAOTIE_*

profiles:
  default:
    model: glm-4.7
    provider: openai

  coding:
    model: claude-3-5-sonnet
    provider: anthropic
    system_prompt: coding_prompt.md
```

---

## 7. 插件系统 (学习 Devika)

### 设计目标
- 支持自定义工具
- 支持自定义命令
- 热加载

### 实现方案
```python
# ~/.xiaotie/plugins/my_tool.py
from xiaotie.tools import Tool, ToolResult

class MyCustomTool(Tool):
    name = "my_tool"
    description = "我的自定义工具"

    async def execute(self, **kwargs) -> ToolResult:
        ...

# 自动发现和加载
```

---

## 实施优先级

| 优先级 | 功能 | 复杂度 | 价值 |
|--------|------|--------|------|
| P0 | 命令系统重构 | 中 | 高 |
| P0 | 增强输出显示 | 低 | 高 |
| P1 | 代码库感知 | 高 | 高 |
| P1 | Git 工具 | 低 | 中 |
| P2 | Web 搜索工具 | 中 | 中 |
| P2 | 多工具并行 | 中 | 中 |
| P3 | 插件系统 | 高 | 中 |

---

## 参考项目

- [Aider](https://github.com/Aider-AI/aider) - 命令系统、RepoMap
- [Open Interpreter](https://github.com/openinterpreter/open-interpreter) - 流式处理、显示
- [Devika](https://github.com/stitionai/devika) - 多 Agent 架构
- [GPT-Engineer](https://github.com/AntonOsika/gpt-engineer) - 项目生成
