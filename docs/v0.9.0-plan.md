# 小铁 v0.9.0 迭代计划

> 基于 CCB 多 AI 协作分析 (Claude + Codex + Gemini + DeepSeek)

---

## 版本目标

**v0.9.0 - Agent SDK & Provider 扩展**

核心目标：
1. 降低自定义 Agent 开发门槛
2. 扩展 LLM Provider 支持
3. 提升用户体验
4. 完善测试覆盖

---

## 功能规划

### P0 - 核心功能

#### 1. Agent SDK v2 (声明式配置)

**目标**: 让自定义 Agent 从"写一套循环"变为"组合组件"

```python
# 目标 API 设计
from xiaotie import AgentBuilder, Tool, Memory

agent = (
    AgentBuilder("my-agent")
    .with_llm("claude-sonnet-4")
    .with_tools([ReadTool(), WriteTool(), BashTool()])
    .with_memory(ConversationMemory(max_tokens=4000))
    .with_hooks(
        on_start=lambda: print("Agent started"),
        on_tool_call=lambda t: print(f"Calling {t.name}"),
    )
    .build()
)
```

**实现要点**:
- `AgentBuilder` 构建器模式
- `AgentSpec` 声明式配置 (YAML/JSON)
- 生命周期 hooks (on_start, on_step, on_tool_call, on_complete)
- 策略/记忆/工具解耦

**复杂度**: 中 | **收益**: 高

#### 2. Provider 适配层 + 能力矩阵

**目标**: 统一接口，支持更多 LLM Provider

| Provider | 流式 | 工具调用 | 并行工具 | 视觉 | 状态 |
|----------|------|----------|----------|------|------|
| Claude | ✅ | ✅ | ✅ | ✅ | 已支持 |
| OpenAI | ✅ | ✅ | ✅ | ✅ | 已支持 |
| GLM-4.7 | ✅ | ✅ | ❌ | ❌ | 已支持 |
| MiniMax | ✅ | ✅ | ❌ | ❌ | 已支持 |
| Gemini | ✅ | ✅ | ✅ | ✅ | **新增** |
| DeepSeek | ✅ | ✅ | ✅ | ❌ | **新增** |
| Qwen | ✅ | ✅ | ✅ | ✅ | **新增** |

**实现要点**:
- 统一 `LLMProvider` 抽象接口
- 能力探测机制 (`capabilities()`)
- 自动路由/降级策略
- OpenAI 兼容端点适配

**复杂度**: 中高 | **收益**: 高

### P1 - 用户体验

#### 3. 命令面板 (Command Palette)

**目标**: 类似 VS Code 的 Ctrl+K 快速命令

**功能**:
- 模糊搜索命令
- 快速切换模型
- 搜索历史记录
- 触发 Agent 技能

**Textual 实现**:
```python
class CommandPalette(ModalScreen):
    def compose(self):
        yield Input(placeholder="Type a command...")
        yield ListView(id="results")

    def on_input_changed(self, event):
        # 模糊搜索匹配
        results = fuzzy_search(event.value, self.commands)
        self.update_results(results)
```

**复杂度**: 中 | **收益**: 高

#### 4. 首次启动向导

**目标**: 零配置启动体验

**流程**:
1. 检测无配置文件
2. TUI 向导引导
3. 输入 API Key
4. 选择默认模型
5. 测试连接
6. 生成配置文件

**复杂度**: 低 | **收益**: 中

### P2 - 测试与文档

#### 5. TUI 交互测试

**目标**: 使用 Textual Pilot 自动化测试

```python
async def test_help_command():
    async with XiaoTieApp().run_test() as pilot:
        await pilot.press("slash")  # /
        await pilot.type("help")
        await pilot.press("enter")
        assert "Available commands" in pilot.app.screen.query_one("#output").text
```

#### 6. LLM 响应录制

**目标**: 使用 VCR.py 录制 API 响应，避免真实调用

```python
@vcr.use_cassette('fixtures/claude_hello.yaml')
async def test_claude_response():
    client = LLMClient(provider="anthropic")
    response = await client.chat("Hello")
    assert "Hello" in response.content
```

#### 7. 文档增强

- VHS 录制动态演示 GIF
- MCP 配置模板和示例
- "Hello World" Agent 教程
- API 参考文档

---

## 架构改进

### 事件驱动解耦

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   TUI/CLI   │ ←── │  Event Bus  │ ←── │    Agent    │
│  (View)     │     │  (Broker)   │     │   (Core)    │
└─────────────┘     └─────────────┘     └─────────────┘
                           ↑
                    ┌──────┴──────┐
                    │   Events    │
                    │ - AgentStart│
                    │ - ToolCall  │
                    │ - Response  │
                    └─────────────┘
```

### 记忆检索管道

```
Query → Rewrite → Semantic Search → Rerank → Context Injection
                      ↓
                  ChromaDB
```

---

## 实施计划

### Week 1-2: Agent SDK v2
- [x] AgentBuilder 实现 ✅
- [x] AgentSpec YAML 解析 ✅
- [x] 生命周期 hooks ✅
- [x] 单元测试 (18 tests) ✅

### Week 3-4: Provider 扩展
- [x] LLMProvider 抽象重构 ✅
- [x] Gemini 适配 ✅
- [x] DeepSeek 适配 ✅
- [x] Qwen 适配 ✅
- [x] 能力矩阵测试 (29 tests) ✅

### Week 5: UX 增强
- [x] Command Palette (26 tests) ✅
- [x] 首次启动向导 (17 tests) ✅
- [x] 流式渲染优化 (23 tests) ✅

### Week 6: 测试与文档
- [x] Textual Pilot 测试 (15 tests) ✅
- [x] LLM 响应录制 (27 tests) ✅ (自研 Cassette 系统替代 VCR.py)
- [x] 文档更新 ✅
- [ ] VHS 演示录制

---

## 参考资源

- [Gemini Function Calling](https://ai.google.dev/gemini-api/docs/tools)
- [Qwen API](https://www.alibabacloud.com/help/en/model-studio/qwen-api-via-dashscope)
- [MCP Protocol](https://docs.anthropic.com/en/docs/mcp)
- [Textual Pilot](https://textual.textualize.io/guide/testing/)
- [VCR.py](https://vcrpy.readthedocs.io/)

---

## 贡献者

- **Claude** - 主导开发
- **Codex** - 功能建议、代码审查
- **Gemini** - UX 设计、文档建议
- **DeepSeek** - 架构分析、性能优化
